# Testing Worker Service with Postman

## Prerequisites
1. **Redis** running: `redis-server`
2. **Event Store** running: `cd events && go run cmd/server/main.go`
3. **Worker** running: `cd worker && go run cmd/server/main.go`

## Step 1: Create Workflow

**POST** `http://localhost:8081/api/v1/events`

**Headers:**
```
Content-Type: application/json
```

**Body:**
```json
{
  "id": "workflow-created-001",
  "source": "postman-test",
  "specversion": "1.0",
  "type": "io.flunq.workflow.created",
  "time": "2025-08-04T12:00:00Z",
  "workflowid": "simple-test-workflow",
  "data": {
    "workflow_id": "simple-test-workflow",
    "name": "Simple Test Workflow",
    "description": "Testing DSL 1.0.0 with Worker service",
    "definition": {
      "document": {
        "dsl": "1.0.0",
        "namespace": "flunq-examples",
        "name": "simple-test-workflow",
        "version": "1.0.0",
        "description": "A simple workflow to test Worker service with DSL 1.0.0"
      },
      "schedule": {
        "on": {
          "any": [
            {
              "with": {
                "type": "io.flunq.execution.started"
              }
            }
          ]
        }
      },
      "do": [
        {
          "initialize": {
            "set": {
              "message": "Workflow started with DSL 1.0.0",
              "timestamp": "${ now() }",
              "user_id": "${ $workflow.input.user_id }",
              "status": "initialized"
            }
          }
        },
        {
          "processData": {
            "set": {
              "processed": true,
              "processing_time": "${ now() }",
              "result": "Data processed successfully"
            }
          }
        },
        {
          "waitStep": {
            "wait": {
              "duration": "PT2S"
            }
          }
        },
        {
          "finalize": {
            "set": {
              "final_status": "completed",
              "completion_time": "${ now() }",
              "summary": "Workflow completed successfully"
            }
          }
        }
      ]
    }
  }
}
```

## Step 2: Start Execution

**POST** `http://localhost:8081/api/v1/events`

**Headers:**
```
Content-Type: application/json
```

**Body:**
```json
{
  "id": "execution-started-001",
  "source": "postman-test",
  "specversion": "1.0",
  "type": "io.flunq.execution.started",
  "time": "2025-08-04T12:01:00Z",
  "workflowid": "simple-test-workflow",
  "executionid": "exec-12345",
  "data": {
    "execution_id": "exec-12345",
    "workflow_id": "simple-test-workflow",
    "correlation_id": "test-correlation-123",
    "started_by": "postman-test",
    "input": {
      "user_id": "test-user-456",
      "message": "Hello from Postman!"
    }
  }
}
```

## Step 3: Check Event History

**GET** `http://localhost:8081/api/v1/events/simple-test-workflow`

This will show you all events for the workflow, including any events generated by the Worker service.

## Expected Worker Behavior

1. **Process workflow.created** - Parse DSL 1.0.0 and store workflow definition
2. **Process execution.started** - Initialize workflow state and start execution
3. **Execute tasks sequentially**:
   - `initialize` - Set initial variables
   - `processData` - Set processing variables  
   - `waitStep` - Wait for 2 seconds
   - `finalize` - Set completion variables
4. **Complete workflow** - Mark execution as completed

## Check Worker Logs

The Worker service will log each step:
```json
{"msg":"Processing workflow event","type":"io.flunq.workflow.created"}
{"msg":"Successfully parsed workflow definition","spec_version":"1.0.0"}
{"msg":"Processing workflow event","type":"io.flunq.execution.started"}
{"msg":"Executing set task","task_name":"initialize"}
{"msg":"Executing set task","task_name":"processData"}
{"msg":"Executing wait task","task_name":"waitStep","duration":"PT2S"}
{"msg":"Executing set task","task_name":"finalize"}
{"msg":"Workflow execution completed"}
```

## Check Redis Data

You can also check the Redis streams directly:
```bash
redis-cli XRANGE events:global - +
redis-cli XRANGE events:workflow:simple-test-workflow - +
```
