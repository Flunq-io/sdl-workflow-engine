# Worker Service

The Worker service executes workflow definitions using the Serverless Workflow DSL.

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DSL Executor   â”‚
â”‚  (State Machine)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚  State Manager  â”‚
â”‚  (Redis/Memory) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Task Scheduler â”‚
â”‚  (Queue/Events) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Event Consumer â”‚
â”‚  (Redis/Kafka)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Features

- **DSL Execution**: Serverless Workflow Definition Language interpreter
- **State Management**: Workflow state persistence and recovery
- **Task Scheduling**: Parallel and sequential task execution
- **Error Handling**: Retry policies, timeouts, and compensation
- **Event-Driven**: React to workflow and task events
- **Scalability**: Horizontal scaling with worker pools

## ğŸ“ Structure

```
worker/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ worker/
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ executor/
â”‚   â”œâ”€â”€ state/
â”‚   â”œâ”€â”€ scheduler/
â”‚   â””â”€â”€ handlers/
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ dsl/
â”‚   â”œâ”€â”€ workflow/
â”‚   â””â”€â”€ tasks/
â”œâ”€â”€ configs/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ go.mod
â””â”€â”€ README.md
```

## ğŸ”§ Configuration

Environment variables:
- `WORKER_ID`: Unique worker identifier
- `CONCURRENCY`: Number of concurrent workflows (default: 10)
- `REDIS_URL`: Redis connection string
- `EVENTS_URL`: Events service URL
- `EXECUTOR_URL`: Executor service URL
- `LOG_LEVEL`: Logging level

## ğŸš€ Quick Start

```bash
# Install dependencies
go mod tidy

# Run locally
go run cmd/worker/main.go

# Build
go build -o bin/worker cmd/worker/main.go

# Run with Docker
docker build -t flunq-worker .
docker run flunq-worker
```

## ğŸ”„ Workflow States

### Execution States
- `PENDING` - Workflow queued for execution
- `RUNNING` - Workflow currently executing
- `COMPLETED` - Workflow finished successfully
- `FAILED` - Workflow failed with error
- `CANCELLED` - Workflow cancelled by user
- `PAUSED` - Workflow paused for manual intervention

### Task States
- `SCHEDULED` - Task queued for execution
- `RUNNING` - Task currently executing
- `COMPLETED` - Task finished successfully
- `FAILED` - Task failed (may retry)
- `SKIPPED` - Task skipped due to conditions

## ğŸ“‹ Supported DSL Features

### States
- **Operation State**: Execute actions/functions
- **Switch State**: Conditional branching
- **Parallel State**: Concurrent execution
- **ForEach State**: Iterate over data
- **Inject State**: Data manipulation
- **Sleep State**: Delays and timeouts
- **Event State**: Wait for events

### Actions
- **Function Calls**: Invoke external services
- **Subflow Calls**: Execute nested workflows
- **Event Publishing**: Emit events

### Error Handling
- **Retry Policies**: Exponential backoff, max attempts
- **Compensation**: Rollback actions
- **Error Events**: Publish error events
